# Mana 项目规划文档

**创建时间**: 2026-01-03
**最后更新**: 2026-01-25
**项目状态**: 核心功能已完成，分析能力待重构优化

---

## 🎯 项目定位

**Mana = 智能账单分析工具**

### 三个核心功能

1. **多数据源转换** → 标准 Beancount 格式
   - 支持支付宝、微信、银行卡、CSV/Excel
   - 智能识别账单格式
   - AI 辅助分类

2. **核心简洁的分析能力** ⭐ **在 Mana 中实现**
   - 基础统计（总支出、收入、净储蓄）
   - 分类统计（15 个标准分类）
   - 时间趋势（月度/年度对比）
   - 异常检测（高额支出、预算超支）
   - 预算对比（实际 vs 预算）

3. **导出 + 深度分析** → Fava 等专业工具
   - 导出标准 .beancount 文件
   - 用户可使用 Fava 查看复杂分析
   - 不重复造轮子

### 与 Fava 的边界

| 功能 | Mana | Fava |
|------|------|------|
| 账单上传转换 | ✅ 核心功能 | ❌ 不支持 |
| 自动智能分类 | ✅ AI + 规则 | ❌ 需手动 |
| 净资产追踪 | ✅ 简洁展示 | ✅ 详细 |
| 分类对比分析 | ✅ vs 上月 | ✅ 完整 |
| 资金流动图 | ✅ 可视化 | ❌ 不支持 |
| 关键洞察提取 | ✅ AI 分析 | ❌ 需自己分析 |
| 异常检测 | ✅ 实时预警 | ❌ 不支持 |
| 预算管理 | ✅ 简单对比 | ✅ 复杂分析 |
| 复式记账报表 | ❌ 不做 | ✅ 完整（资产负债表、损益表）|
| BQL 查询 | ❌ 不做 | ✅ 灵活查询 |
| 投资分析 | ❌ 不做 | ✅ 支持 |
| 在线编辑账本 | ❌ 不做 | ✅ 支持 |

**设计原则**:
- Mana：自动导入 + 关键洞察 + 简洁可视化
- Fava：手动记账 + 专业报表 + 灵活查询
- **借鉴 Beancount 的分析思维，保持 Mana 的简洁定位**

---

## 📊 分析能力设计

### 🔍 从 Beancount 学到的核心理念

**研究日期**: 2026-01-25
**参考文档**: `BEANCOUNT_ANALYSIS_CAPABILITIES.md`

#### Beancount 的核心优势

1. **复式记账思维** → 数据完整性和全局视角
   - 不只看"花了多少"，更要看"还剩多少"
   - 追踪资金流动：钱从哪来，到哪去

2. **三大财务报表**
   - 资产负债表：看"家底"（净资产 = 资产 - 负债）
   - 损益表：看"收支"（净收益 = 收入 - 支出）
   - 试算平衡表：验证数据准确性

3. **时间维度**
   - 任意时间点的财务快照
   - 历史对比和趋势分析

4. **灵活查询**
   - BQL 查询语言（类似 SQL）
   - 自定义分析维度

#### Mana 的借鉴策略

**✅ 借鉴**（保持简洁）:
- 净资产追踪（资产 - 负债）
- 资金流动可视化
- 分类对比分析（vs 上月）
- 时间点快照
- 账户层级展示

**❌ 不借鉴**（保持边界）:
- 复杂会计报表（试算平衡表）
- 手动记账功能
- 投资组合分析
- BQL 查询语言

**🎯 核心原则**:
> "从数据展示 → 洞察驱动"
> "不展示更多数据，而是提供更深的洞察"

---

### Mana 提供的核心分析能力（重构后）

#### 1. 关键洞察卡片（最重要）⭐ 新增

**目标**: 一眼看懂财务状况，直接给出行动建议

**展示内容**:
```
📊 本月财务洞察

💰 支出增加 23% (¥1,234)
   主要原因：外卖支出翻倍（¥856 → ¥1,712）

🎯 建议行动
   • 减少外卖频次，每周控制在 3 次以内
   • 预计可节省 ¥428/月

⚠️ 异常发现
   • 12月15日单笔支出 ¥2,340（京东-数码产品）
   • 超过日常平均支出 8 倍
```

**技术实现**:
- AI 分析：识别支出变化原因
- 智能建议：基于历史数据给出可操作建议
- 异常检测：自动发现异常模式

---

#### 2. 净资产追踪 ⭐ 新增

**目标**: 看到真实的财富增长，而不只是支出

**展示内容**:
```
💎 净资产: ¥50,000
├── 资产: ¥60,000
│   ├── 银行存款: ¥30,000
│   ├── 支付宝: ¥15,000
│   └── 微信: ¥5,000
└── 负债: ¥10,000
    ├── 信用卡: ¥8,000
    └── 花呗: ¥2,000

vs 上月: +¥5,000 (+11%)
```

**洞察力**:
- 更全面的财务健康评估
- 负债管理意识
- 真实的财富增长追踪

---

#### 3. 分类对比分析（改进）

**当前问题**: 只显示本月金额和占比，缺乏对比

**改进方案**:
```
📈 支出变化 Top 3

1. 外卖 +100% (¥856 → ¥1,712)  ⚠️ 异常增长
2. 购物 +45% (¥1,200 → ¥1,740)  ⚠️ 需关注
3. 交通 -20% (¥500 → ¥400)     ✅ 控制良好
```

**展示内容**:
- vs 上月对比（增长/下降百分比）
- 突出变化最大的分类
- 状态标识（异常/正常/优秀）

---

#### 4. 资金流动图 ⭐ 新增

**目标**: 可视化资金流向，回答"钱都去哪了"

**展示内容**:
```
工资 ¥15,000
  ↓
银行 ¥15,000
  ↓
├─ 外卖 ¥2,000 (13%)
├─ 购物 ¥3,000 (20%)
├─ 房租 ¥4,000 (27%)
└─ 储蓄 ¥6,000 (40%)
```

**技术实现**:
- Sankey 图或流程图
- 交互式：点击查看详情
- 动态计算：基于实际交易

---

#### 5. 财务健康评分（简化）

**当前问题**: 指标过多（6 个），用户难以抓住重点

**改进方案**:
```
💯 财务健康评分：72/100

✅ 储蓄率 25%（优秀）
⚠️ 支出波动性高（需改善）
✅ 预算执行率 85%（良好）
```

**评分维度**:
- 储蓄率（权重 40%）
- 支出稳定性（权重 30%）
- 预算执行率（权重 30%）

---

#### 6. 时间趋势（保留）

- **最近 6 个月**的支出趋势
- **本月 vs 上月**对比（增长/下降）
- **净资产变化**趋势 ⭐ 新增

**展示形式**: 折线图 + 柱状图

---

#### 7. 异常检测（保留）

**检测类型**:
- 单笔高额支出（远超历史平均值）
- 预算超支预警
- 分类异常增长（vs 上月 >50%）⭐ 新增

**展示形式**: 警告卡片 + 详细说明

---

#### 8. 预算对比（保留）

**展示内容**:
- 每个分类的预算金额
- 已支出金额
- 完成百分比
- 状态指示（安全/警告/危险/超支）

**展示形式**: 进度条 + 状态色

---

### Mana 不做的分析功能

以下功能**不在 Mana 中实现**，用户导出后使用 Fava 查看：

- ❌ 复式记账报表（资产负债表、损益表、试算平衡表）
- ❌ BQL 查询语言（灵活查询）
- ❌ 复杂的钻取分析（点击分类查看所有交易）
- ❌ 投资组合分析
- ❌ 复杂的时间序列分析（周度、季度）
- ❌ 商户分析（按商户统计）
- ❌ 高级可视化（热力图、雷达图、树状图）
- ❌ 自定义报表
- ❌ 多维度交叉分析
- ❌ 在线编辑 Beancount 文件

**原因**: 保持 Mana 的"核心简洁"定位，复杂分析交给专业工具

**已有代码**: `app/lib/analyzers/anomaly.ts`

#### 5. 预算对比（实际 vs 预算）
**数据来源**: `user_settings.budgets`

**展示内容**:
- 每个分类的预算金额
- 已支出金额
- 完成百分比
- 状态指示：
  - 🟢 安全 (<50%)
  - 🟡 警告 (50-80%)
  - 🟠 危险 (80-100%)
  - 🔴 超支 (>100%)

**展示形式**: 进度条 + 状态色

### Mana 不做的分析功能

以下功能**不在 Mana 中实现**，用户导出后使用 Fava 查看：

- ❌ 复杂的钻取分析（点击分类查看所有交易）
- ❌ 财务报表（资产负债表、损益表）
- ❌ 投资组合分析
- ❌ 复杂的时间序列分析（周度、季度）
- ❌ 商户分析（按商户统计）
- ❌ 高级可视化（热力图、雷达图、树状图）
- ❌ 自定义报表
- ❌ 多维度交叉分析

### 技术实现要点

#### 数据来源
```typescript
// 从 uploads 表的 parsed_data 字段提取
interface Upload {
  parsed_data: string; // JSON: Array<ParsedBill>
  // ParsedBill 包含: { id, amount, description, transactionDate, category, ... }
}
```

#### 计算逻辑
```typescript
// app/lib/analytics/
├── calculator.ts    // 统计计算（基础统计、分类统计）
├── trends.ts        // 趋势分析（月度对比）
└── budget.ts        // 预算对比
```

#### 可视化方案
**选项 1: 使用图表库**（推荐）
- `recharts` - React 友好，轻量
- 适合：折线图、柱状图、条形图

**选项 2: 纯 CSS 实现**
- 适合：进度条、简单条形图
- 更轻量，无依赖

**建议**: 混合使用
- 复杂图表（趋势图）：recharts
- 简单展示（进度条、排行）：CSS

#### 页面位置
- **主展示区**: 新建 `/analytics` 路由（分析页面）
- **集成区**: 在 `/bills` 页面顶部添加统计概览
- **详情区**: 点击账单查看该账单的统计

### 实施优先级

#### P0 - MVP（6-8小时）✅ 已完成
1. ✅ 基础统计卡片（4 个数字）
2. ✅ 分类统计（条形图 + 排行榜）
3. ✅ 预算对比（进度条）
4. ✅ 异常检测 UI（已有逻辑）

#### P1 - 增强功能（2-3小时）✅ 已完成
5. ✅ 时间趋势（折线图）
6. ✅ 月度对比（数字 + 增长率）

#### P2 - 优化（1-2小时）⏳ 部分完成
7. ⏳ 响应式优化
8. ⏳ 加载动画
9. ✅ 交互优化（时间范围筛选）

---

## 💬 对话回顾

### 第 1-2 轮：需求收集
- **项目类型**: Web 应用
- **技术栈**: JavaScript/TypeScript
- **账单来源**: 支付宝/微信、银行卡账单、Excel/CSV
- **核心功能**: 收支分类统计、异常检测

### 第 3-4 轮：技术选型
- **选择**: React Router v7 (原 Remix)
- **理由**:
  - 服务器端处理账单文件更高效
  - 表单处理（文件上传）更优雅
  - Cloudflare 集成更成熟

### 第 5-8 轮：项目初始化
- 创建项目结构
- 配置 Cloudflare 适配器
- 安装依赖并修复冲突
- 实现解析器和分析器代码

---

## 🎯 项目需求

### 核心功能

#### 1. 账单转换 ✅ 已完成
- [x] 账单解析（支付宝、微信、CSV）
- [x] 智能分类（基于关键词 + AI）
- [x] Beancount 格式生成
- [x] 云端存储（D1 + R2）

#### 2. 分析能力 ✅ 已完成
- [x] 基础统计（总支出、收入、净储蓄、日均支出）
- [x] 分类统计（15 个标准分类的金额和占比）
- [x] 时间趋势（月度对比、年度对比）
- [x] 异常检测（高额支出、预算超支）
- [x] 预算对比（实际支出 vs 预算设置）
- [x] 简洁可视化（核心图表，使用 recharts）

#### 3. 导出功能 ✅ 已完成
- [x] 下载 .beancount 文件
- [x] 下载原始文件
- [x] 账单历史管理

### 技术约束
- 部署平台: Cloudflare (Pages + Workers)
- 数据库: Cloudflare D1 (SQLite)
- 存储: Cloudflare R2
- 支持本地开发

---

## ✅ 做得好的地方

### 1. 项目结构清晰
```
app/
├── routes/          # 页面路由
├── lib/
│   ├── db/         # 数据库层
│   ├── parsers/    # 解析器（3个格式）
│   └── analyzers/  # 分析器
```
- 分层合理，职责清晰
- 便于扩展新的账单格式

### 2. 数据库设计合理
- `bills` 表：存储账单数据
- `categories` 表：分类规则（支持关键词匹配）
- `anomalies` 表：异常记录
- 索引优化：date、category、source
- 预置分类数据

### 3. 解析器架构统一
```typescript
interface ParsedBill {
  id: string;
  amount: number;
  description: string;
  transactionDate: string;
  originalData: Record<string, any>;
}
```
- 统一接口设计
- 保留原始数据便于追溯

### 4. TypeScript 类型安全
- 所有文件使用 TypeScript
- 通过类型检查（tsc 无错误）
- 使用 Cloudflare Workers 类型定义

### 5. 文档齐全
- README.md：项目说明
- QUICKSTART.md：快速开始指南
- REVIEW.md：本文档

---

## ⚠️ 当前开发状态

### 已完成功能（2025-01-16 更新）

✅ **文件上传处理** - `app/routes/bills.new.tsx` 已实现完整的 action 函数
✅ **数据库连接** - 通过 `context.env.DB` 正确访问 D1 数据库
✅ **Cloudflare 适配器** - `vite.config.ts` 已配置 Cloudflare 适配器
✅ **Excel 文件支持** - 支持解析 .xlsx 和 .xls 格式的账单文件
✅ **客户端解析器** - 在浏览器中完成账单解析和分类

### 部分实现功能

⚠️ **AI 智能列识别** - 客户端部分已完成，服务端 API 待实现
⚠️ **数据库配置** - 代码已就绪，需用户配置 `wrangler.toml` 中的 database_id

### 中优先级问题

#### 4. 缺少错误处理
**位置**: `app/lib/parsers/*.ts`

**问题**: 解析器没有足够的错误处理

```typescript
// app/lib/parsers/alipay.ts:38
const bill: ParsedBill = {
  amount: Math.abs(parseFloat(amount || '0')),
  // ❌ 如果 parseFloat 返回 NaN 怎么办？
};
```

---

#### 5. 路由类型问题
**位置**: `app/routes/_index.tsx`, `app/routes/bills.new.tsx`

**问题**: 移除了 `Route.MetaArgs` 等类型

```typescript
// app/routes/_index.tsx
export function meta() { // ❌ 缺少参数
```

---

#### 6. 缺少核心页面
- 账单列表页面 (`routes/bills.list.tsx`)
- 统计分析页面 (`routes/analytics.tsx`)
- 设置页面 (`routes/settings.tsx`)

---

### 低优先级问题

#### 7. 安全问题
- 没有文件大小限制
- 没有严格的文件类型验证
- 缺少 XSS 防护

#### 8. 缺少测试
- 没有单元测试
- 没有集成测试

---

## 🔧 修复计划

### 高优先级（必须修复）
1. 实现文件上传 action
2. 配置 Cloudflare 上下文和数据库连接
3. 修复 Vite 配置的 Cloudflare 适配器
4. 实现账单列表页面

### 中优先级（影响开发体验）
5. 添加错误处理和验证
6. 实现统计分析页面
7. 实现设置页面（管理分类规则）

### 低优先级（功能完善）
8. 添加图表可视化
9. 实现用户认证（如需要）
10. 添加单元测试

---

## 📊 评分

| 维度 | 评分 | 说明 |
|------|------|------|
| **架构设计** | ⭐⭐⭐⭐⭐ | 清晰的分层，易于扩展 |
| **代码质量** | ⭐⭐⭐⭐ | TypeScript 覆盖好，客户端解析健壮 |
| **功能完整性** | ⭐⭐⭐⭐ | 核心上传/解析/存储已完成，待补充列表和分析页面 |
| **文档** | ⭐⭐⭐⭐ | 文档齐全但需更新进度 |
| **可部署性** | ⭐⭐⭐⭐ | Cloudflare 适配器已配置，可部署测试 |

**整体评价**: 8.5/10（较 7/10 提升）

---

## 📝 开发日志

### 2026-01-29
- ✅ **TypeScript 类型安全修复** - 修复项目中所有 TypeScript 错误
  - 修复了 `workers/app.ts` 中的多个类型错误
  - 添加了缺失的类型定义和接口
  - 提高了类型安全性，替换了 any 类型
  - 确保项目能够正常构建和部署
- ✅ **项目计划更新** - 整理并更新项目计划
  - 标记已完成的任务
  - 总结项目进展和技术要点
  - 明确下一步行动方向

### 2025-01-25
- ✅ **数据分析功能完成** - 实现核心简洁的分析能力
  - 创建分析页面 `app/routes/analytics.tsx`
  - 实现财务概览卡片（FinancialOverview）
  - 实现基础统计（calculateSummary.ts）
    - 总支出、总收入、净储蓄
    - 日均支出、交易笔数、最大单笔支出
    - 月度对比增长率
  - 实现分类统计（15个标准分类）
    - 饼图展示（CategoryPieChart）
    - 条形图列表（CategoryList）
  - 实现时间趋势分析（trends.ts）
    - 月度数据聚合（aggregateByMonth）
    - 折线图展示（TrendLineChart）
    - 月度柱状图（MonthlyBarChart）
  - 实现异常检测可视化（AnomalyAlert）
  - 实现预算对比展示（BudgetProgress）
  - 集成 recharts 图表库
  - 添加时间范围筛选（DateRangeFilter）
    - 本月、上月、近3个月、近6个月、本年、全部
  - 提交：400f547, 71020ce, 10afbcb, c11606e, 8ae8cee 等
- ✅ **项目定位明确**：智能账单分析工具（三个核心功能）
  1. 多数据源转换 → Beancount 格式
  2. **核心简洁的分析能力**（在 Mana 中实现）⭐
  3. 导出 + Fava 深度分析
- ✅ 实现账单历史列表页面（app/routes/bills.tsx）
  - 从 localStorage 迁移到 D1 云端存储
  - 支持按名称搜索
  - 支持按日期/名称/金额排序
  - 显示分类统计分布
  - 支持下载原始文件和 Beancount 文件
- ✅ 在首页和账单页添加"设置"导航链接
- ✅ 转换完成后自动保存到云端
- ✅ 发现并修复路由配置问题（需在 app/routes.ts 中显式配置）
- ✅ 文档规范更新：重命名 REVIEW.md 为 PLAN.md
- ⚠️ **架构升级完成**：从 localStorage 迁移到 Cloudflare D1 + R2
  - ✅ 创建项目级 `.claude` 目录并移动计划文件
  - ✅ 创建 D1 数据库（database_id: fd67e0ee-85da-42b2-aa1b-c3f3f101100f）
  - ✅ 更新 wrangler.toml 配置
  - ✅ 重构 schema.sql（uploads 表 + user_settings 表）
  - ✅ 本地和生产环境数据库表创建成功
  - ✅ 创建 R2 存储桶（mana-uploads）
  - ✅ **阶段2-5完成**：服务层、API、页面迁移、测试部署
- ✅ **设置页面完成**：云端存储（D1）
  - 创建 `app/lib/db/settings.ts` - 设置数据操作
  - 创建 `app/routes/api.settings.ts` - 设置 API
  - 创建 `app/routes/settings.tsx` - 设置 UI
  - 支持自定义规则管理（云端同步）
  - 支持预算配置
  - 解析器集成云端规则
- ✅ **文档更新**：明确分析能力边界
  - Mana：核心简洁分析（统计、分类、趋势、异常、预算）
  - Fava：复杂深度分析（财务报表、钻取、投资等）

### 2025-01-16
- ✅ 实现完整的文件上传处理（客户端解析 + 服务端存储）
- ✅ 添加 Excel 文件支持（.xlsx, .xls）
- ✅ 实现 AI 智能列识别的客户端部分
- ✅ 部署到 Cloudflare Pages 并测试通过
- ⚠️ 发现 React hydration error #418（已知框架问题，不影响功能）

### 2026-01-03
- ✅ 项目初始化完成
- ✅ TypeScript 类型检查通过
- ⚠️ 核心功能待实现

---

## 🎯 下一步行动

1. **完成 MVP 发布前的必要任务**（1-2 天）
   - 任务 8: 本地测试完整流程（1小时）
   - 任务 9: 安全加固（2小时）
   - 编写用户文档（4小时）

2. **分析能力重构 - Phase 1**（1 周）⭐ 基于 Beancount 研究
   - 任务 10: 核心洞察（关键洞察卡片、净资产追踪、分类对比）
   - 目标：从"数据展示"转变为"洞察驱动"
   - 参考：`BEANCOUNT_ANALYSIS_CAPABILITIES.md`

3. **发布 MVP 并收集反馈**（持续）
   - 完善 README（添加截图）
   - 发布到技术社区（V2EX、掘金）
   - 收集用户反馈

4. **根据反馈决定后续优化**
   - Phase 2: 可视化增强（资金流动图、净资产趋势）
   - Phase 3: 智能建议（支出优化、预算调整）

---

## ✅ 任务清单 (TODO)

### 高优先级任务（必须完成）

- [x] **1. 配置 Cloudflare 适配器和上下文** ✅
  - 修改 `vite.config.ts` 添加 Cloudflare 适配器
  - 创建 `app/cloudflare.ts` 配置环境类型
  - 更新 `app/root.tsx` 添加 loader 获取 env
  - **状态**: ✅ 已完成（2025-01-16）
  - **提交**: cbb4143, 6260aac

- [x] **2. 实现文件上传 Action 处理** ✅
  - 在 `app/routes/bills.new.tsx` 添加 action 函数
  - 实现文件接收和验证逻辑
  - 根据来源选择合适的解析器
  - 将解析结果保存到数据库
  - **状态**: ✅ 已完成（2025-01-16）
  - **提交**: 94bbe3a

- [x] **3. 实现账单列表页面** ✅
  - 创建 `app/routes/bills.tsx`
  - 使用 localStorage 存储（最多30条记录）
  - 显示账单列表（支持搜索、排序）
  - 支持下载和删除账单记录
  - **状态**: ✅ 已完成（2025-01-25）
  - **提交**: e3546ea
  - **预计时间**: 1.5 小时
  - **实际时间**: ~2 小时
  - **依赖**: 任务 2

- [x] **4. 配置 Cloudflare D1 数据库（部分完成）** ⚠️
  - 运行 `wrangler d1 create mana-db` 创建数据库
  - 更新 `wrangler.toml` 填入 database_id
  - 执行 schema.sql 初始化表结构
  - 测试本地数据库连接
  - **状态**: ⚠️ 代码已就绪，需用户配置 database_id
  - **预计时间**: 15 分钟（用户操作）

### 中优先级任务（功能完善）

- [x] **5. 添加错误处理和文件验证** ✅
  - 文件大小限制（最大 10MB）
  - 文件类型验证（MIME type + 扩展名）
  - 解析错误处理和友好提示
  - 数据验证（金额、日期格式等）
  - **状态**: ✅ 已完成（2026-01-25）
  - **预计时间**: 1 小时
  - **实际时间**: ~1 小时

- [x] **6. 实现设置页面** ✅
  - 创建 `app/routes/settings.tsx`
  - 管理分类规则（增删改）
  - 设置预算限制
  - 云端存储（D1 数据库）
  - **状态**: ✅ 已完成（2025-01-25）
  - **预计时间**: 2 小时
  - **实际时间**: ~2 小时

- [x] **7. 实现核心简洁的分析能力** ✅ **已完成**
  - 基础统计卡片（总支出、收入、净储蓄、日均）
  - 分类统计展示（15 个标准分类）
  - 月度趋势对比（简洁版，使用 recharts 图表）
  - 预算对比展示（实际 vs 预算）
  - 异常检测可视化（警告卡片）
  - **设计原则**: 核心简洁，复杂分析交给 Fava
  - **状态**: ✅ 已完成（2025-01-25）
  - **预计时间**: 6-8 小时
  - **实际时间**: ~8 小时
  - **依赖**: 任务 6

### 分析能力重构（基于 Beancount 研究）

- [x] **10. 分析页面重构 - Phase 1（核心洞察）** ⭐ 已完成
  - ✅ 实现"关键洞察卡片"（AI 分析 + 行动建议）
  - ✅ 添加"净资产追踪"（资产 - 负债）
  - ✅ 改进"分类对比分析"（vs 上月，突出变化）
  - ✅ 优化"财务健康评分"（简化指标，3 个维度）
  - **状态**: ✅ 已完成（2026-01-31）
  - **预计时间**: 4-6 小时
  - **实际时间**: ~8 小时
  - **优先级**: P0（高）
  - **依赖**: 任务 7
  - **参考**: `BEANCOUNT_ANALYSIS_CAPABILITIES.md`

- [ ] **11. 分析页面重构 - Phase 2（可视化增强）** ⭐ 待开始
  - 实现"资金流动图"（Sankey 图或流程图）
  - 添加"净资产变化趋势"（折线图）
  - 改进"分类统计"（树状层级展示）
  - 优化图表交互（点击钻取、筛选）
  - **状态**: ⏳ 待开始
  - **预计时间**: 3-4 小时
  - **优先级**: P1（中）
  - **依赖**: 任务 10

- [ ] **12. 分析页面重构 - Phase 3（智能建议）** ⭐ 待开始
  - 实现"智能支出建议"（基于历史数据）
  - 添加"预算优化建议"（自动调整预算）
  - 实现"异常模式识别"（周期性异常）
  - 添加"时间点快照"（查看任意时间点状态）
  - **状态**: ⏳ 待开始
  - **预计时间**: 4-5 小时
  - **优先级**: P2（低）
  - **依赖**: 任务 11

### 测试和部署

- [ ] **8. 本地测试完整流程**
  - 测试文件上传功能
  - 测试账单列表展示
  - 测试 Fava 集成（查看 beancount 文件）
  - 修复发现的 bug
  - **状态**: ⏳ 待开始
  - **预计时间**: 1 小时
  - **优先级**: P0（高）
  - **依赖**: 任务 2、3

### 低优先级任务（后续优化）

- [ ] **9. 安全加固**
  - 添加 CSRF 保护
  - 文件上传安全检查
  - XSS 防护
  - **状态**: ⏳ 待开始
  - **预计时间**: 2 小时
  - **优先级**: P0（高）

- [x] **11. 部署到 Cloudflare** ✅
  - 创建 Cloudflare Pages 项目
  - 配置环境变量
  - 执行生产数据库迁移
  - 测试线上功能
  - **状态**: ✅ 已完成（2025-01-25）
  - **提交**: 多次提交，最终版本 947c92c4

---

## 📈 进度追踪

**总任务数**: 12（新增 3 个分析重构任务）
**已完成**: 8（任务1、2、3、4部分、5、6、7、11）
**部分完成**: 1（任务4需用户配置database_id）
**进行中**: 0
**待开始**: 5（任务8、9、10、11、12）

**完成度**: 67% (8/12 任务已完成或部分完成)

**当前阶段**: 分析能力重构（基于 Beancount 研究）

**下一步行动**:
1. 完成任务 8（测试）和任务 9（安全）- 发布 MVP
2. 开始任务 10（分析重构 Phase 1）- 核心洞察
3. 根据用户反馈决定是否继续 Phase 2 和 Phase 3

**更新时间**: 2026-01-25

---

*本文档将随项目进展持续更新*
